<!--
    Modified from https://illuminate.dotasphere.com/
    I don't claim to be a good web developer but this was mainly done as
    a test to see how you can host on Github a link to your own domain.
    This code started as a copy of Bongikairu's so many thanks to him ;D
-->
<!doctype html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120833732-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-127734786-4');
    </script>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ArtifactHistory</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script defer src="https://pro.fontawesome.com/releases/v5.6.1/js/all.js" integrity="sha384-ncMWtRMSOo+cLmfdaa6vmMGzBJKysBDF9tq5YK1MAnAjcyipdW2vgTS1jOntY4fs" crossorigin="anonymous"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.1/superhero/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-fiZOWGBt79dIbkt852eb24nKPxYOvAgtp4v4IUFozlwV/WkvlilK1oTVfPorZdV4" crossorigin="anonymous">
    <style>
        body {
            margin-top: 1rem;
            margin-bottom: 1rem;
            background:#464646;
        }

        #filter_title {
            margin-top: 4px;
        }

        td.match {
            width: 16em;
        }

        td.icon {
            width: 7em;
        }

        .table th, .table td {
            border-top: 1px solid #dee2e642;
        }

        .card {
            background: #1c2127;
        }

        .win {
            color: #5cb85c;
        }

        .lose {
            color: #d9534f;
        }

        .score_k {
            color: #5cb85c;
        }

        .score_d {
            color: #d9534f;
        }

        .score_a {
            color: #f0ad4e;
        }

        .kda_spacer {
            margin: 0 4px;
        }

        .commend {
            color: #5cb85c;
        }

        .report {
            color: #d9534f;
        }

        .commend .svg-inline--fa, .report .svg-inline--fa {
            margin-right: 0.3em;
        }

        td.summary {
            padding-bottom: 2rem;
        }

        .summary hr {
            margin: 0.5rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

    </style>
    <style id="filter_style">

    </style>
</head>

<body>

<div class="container">

    <h1>ArtifactHistory</h1>
    <h2>Your current Artifact game history</h2>

    <hr/>

    <div id="output" style="display: none" class="mt-3">
        <div class="card">
            <div class="card-body">
                <div class="card-title float-left" id="output_title"></div>
                <div class="float-right">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-secondary">
                            <input type="checkbox" autocomplete="off" id="filter_commend"> Commended
                        </label>
                        <label class="btn btn-secondary">
                            <input type="checkbox" autocomplete="off" id="filter_report"> Reported
                        </label>
                    </div>
                </div>
                <div class="float-right mr-3">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                            <input type="radio" name="filter_outcome" autocomplete="off" checked
                                   id="filter_outcome_all" value="all"> All
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="filter_outcome" autocomplete="off" id="filter_outcome_win"
                                   value="win"> Win
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="filter_outcome" autocomplete="off" id="filter_outcome_lose"
                                   value="lose"> Lose
                        </label>
                    </div>
                </div>
                <h5 id="filter_title" class="card-title float-right mr-3">Filter: </h5>
                <p class="card-text" id="output_data">

                </p>
            </div>
            <div id="loading" class="card-footer">
                <i class="far fa-spinner fa-spin"></i> Loading ...
            </div>
        </div>
    </div>

    <div id="whatis" class="hideondata">
        <h3>What is this?</h3>
        This site will display all your current Artifact game history and statistics from the data you insert.
        I previously developed this as a <a href="https://github.com/JoshLmao/ArtifactAPI.MatchHistory">WPF application</a> and now
        have an online version!
    </div>

    <div id="instruction" class="mt-3 hideondata">
        <h3>Instructions</h3>
        <ol>
            <li>
                Open <a href="https://steamcommunity.com/my/gcpd/583950/?category=Games&tab=MatchPlayers" target="_blank">this link</a> to view your current Artifact game history
            </li>
            <li>
                <div>Type <b>javascript:</b> into your url and paste the following code after it
                </div>
                <textarea id="script_box" class="form-control" readonly style="color: white;">
                    (()=>{const read_data=()=>{const player_name=document.getElementsByClassName("profile_small_header_name")[0].children[0].textContent;const row_list=document.getElementById("personaldata_elements_container").querySelectorAll("tr");let all_output="";for(let i=1;i<row_list.length;i++){const col_list=row_list[i].querySelectorAll("td");let output="";for(let j=0;j<col_list.length;j++){output+=col_list[j].textContent+(j==col_list.length-1?"":"|")}
                    all_output+=output+(i==row_list.length-1?"":",")}
                    window.location="https://artifacthistory.joshlmao.com/#"+all_output};const b1=document.getElementById("load_more_button");const b2=document.getElementById("inventory_history_loading");const has_more=()=>{return(b1&&b1.style.display!=="none")||(b2&&b2.style.display!=="none")};const has_load_more=()=>b1&&b1.style.display!=="none";const load_more=()=>b1.click();const watch_load_more=()=>{const interval=setInterval(()=>{if(has_load_more()){load_more()}else{if(!has_more()){clearInterval(interval);console.log(`done`);read_data()}}},100)};const b3=document.getElementById("personaldata_elements_container");const h1=document.createElement("h1");const h1text=document.createTextNode("Loading more data ");const h1spinner=document.createElement("img");h1spinner.src="https://steamcommunity-a.akamaihd.net/public/images/login/throbber.gif";h1.appendChild(h1text);h1.appendChild(h1spinner);b3.insertBefore(h1,b3.childNodes[0]);watch_load_more()})()
                </textarea>
            </li>
            <li>
                Wait until you're redirected to another page <b>(should be "artifacthistory.joshlmao.com/#...")</b> which will display all your game history and statistics!
            </li>
        </ol>
    </div>

    <div class="mt-3">
        <h3>Github Repository</h3>
        <span>
            If you're interested in how this works, want to download the source code or help fix issues, check out the repo!
            <a href="https://github.com/JoshLmao/ArtifactAPI.MatchHistory">https://github.com/JoshLmao/ArtifactAPI.MatchHistory</a>
        </span>
    </div>

    <hr/>

    <div class="mt-3 text-center text-muted">
        <div>by <a href="https://github.com/joshlmao">@joshlmao</a></div>
        <div>Code derived from <a href="https://github.com/bongikairu">@bongikairu</a></div>
    </div>

</div>

</body>

<script>
    $(() => {
        $("#script_box").click(() => {
            $("#script_box").select();
        });

        let filter_outcome = "all";
        let filter_commend = false;
        let filter_report = false;

        const regenerate_style = () => {

            let style_text = ".match_row { display: none; } ";
            if (filter_commend && filter_report) {
                if (filter_outcome === "win") {
                    style_text += `.outcome_win.data_commend.data_report { display: table-row; } `;
                } else if (filter_outcome === "lose") {
                    style_text += `.outcome_lose.data_commend.data_report { display: table-row; } `;
                } else {
                    style_text += `.data_commend.data_report { display: table-row; } `;
                }
            } else if (filter_commend) {
                if (filter_outcome === "win") {
                    style_text += `.outcome_win.data_commend { display: table-row; } `;
                } else if (filter_outcome === "lose") {
                    style_text += `.outcome_lose.data_commend { display: table-row; } `;
                } else {
                    style_text += `.data_commend { display: table-row; } `;
                }
            } else if (filter_report) {
                if (filter_outcome === "win") {
                    style_text += `.outcome_win.data_report { display: table-row; } `;
                } else if (filter_outcome === "lose") {
                    style_text += `.outcome_lose.data_report { display: table-row; } `;
                } else {
                    style_text += `.data_report { display: table-row; } `;
                }
            } else {
                if (filter_outcome === "win") {
                    style_text += `.outcome_win { display: table-row; } `;
                } else if (filter_outcome === "lose") {
                    style_text += `.outcome_lose { display: table-row; } `;
                } else {
                    style_text += `.data_unknown { display: table-row; } `;
                    style_text += `.outcome_unknown { display: table-row; } `;
                    style_text += `.outcome_win { display: table-row; } `;
                    style_text += `.outcome_lose { display: table-row; } `;
                }
            }
            $("#filter_style").text(style_text);
        };
        regenerate_style();

        $("#filter_commend").click(function () {
            const val = $(this).is(':checked');
            filter_commend = val;
            if (val) {
                $(this).parent().addClass("active");
            } else {
                $(this).parent().removeClass("active");
            }
            regenerate_style();
        });
        $("#filter_report").click(function () {
            const val = $(this).is(':checked');
            filter_report = val;
            if (val) {
                $(this).parent().addClass("active");
            } else {
                $(this).parent().removeClass("active");
            }
            regenerate_style();
        });
        $("input[name=filter_outcome]").click(function () {
            const val = $(this).val();
            filter_outcome = val;
            $(this).parent().parent().children().removeClass("active");
            $(this).parent().addClass("active");
            regenerate_style();
        });

        // clear broken data
        for (let key in localStorage) {
            if (key.startsWith("match-")) localStorage.removeItem(key);
        }

        if (location.hash && location.hash !== "#") 
        {
            const $output = $("#output");
            $(".hideondata").hide();
            $output.show();
            const raw_data = location.hash.substring(1);
            const data = raw_data.split(",");
            const decoded = decodeURI(data[0]);
            const name = decoded.split('|')[1];
            $("#output_title").append(`<h2>${name}'s reported data</h2>`);
            const $table = $(`<table class="table table-striped table-sm"></table>`);
            const $tbody = $(`<tbody></table>`);
            $("#output_data").append($table);
            $table.append($tbody);

            let last_row_id = "";
            let last_row_elem = null;
            let last_row_summary = null;

            /*Populate a row with the data*/
            const create_row = (data) => {
                const {
                    match_id,
                    account_id,
                    match_mode,
                    duration,
                    server_version,
                    match_outcome,
                    total_turns,
                    start_time,
                    cluster_id,
                    team,
                    flags,
                    tower1,
                    tower2,
                    tower3,
                    ancient,
                    game_clock,
                    hero_1,
                    hero_2,
                    hero_3,
                    hero_4,
                    hero_5,
                    gauntlet_type,
                    deck_code,
                } = data;

                const outcome_el = match_outcome == team ? '<span class="win ml-1 font-weight-bold">WIN</span>' : '<span class="lose ml-1 font-weight-bold">LOSE</span>';

                const col1 = (`<td class="match text-right"><a href="https://www.opendota.com/matches/${match_id}" target="_blank">${match_id}</a> ${outcome_el}<br /><span class="gamemode mr-1">${match_mode}</span><span class="duration mr-1">${duration}</span><a class="opendota" href="https://www.opendota.com/matches/${match_id}" target="_blank">&lt;/&gt;</a> <a class="dotabuff" href="https://www.dotabuff.com/matches/${match_id}" target="_blank">D</a> <a class="stratz" href="https://stratz.com/en-us/match/${match_id}" target="_blank">⇑</a><br />${start_time}</td>`);
                const col2 = (`<td class="icon pb-1 text-center"><img class="mb-1 mt-1" src="${hero_1}" height="30"><br /><span class="score_k">${tower1}</span><span class="kda_spacer">/</span><span class="score_d">${tower2}</span><span class="kda_spacer">/</span><span class="score_a">${tower3}</span></td>`);
                let summary_list = [];
                /*if (report_comm) summary_list.push(`<span class="report"><i class="far fa-headphones"></i> Reported: Comm Abuse</span>`);
                if (report_abi) summary_list.push(`<span class="report"><i class="far fa-magic"></i> Reported: Ability Abuse</span>`);
                if (report_feed) summary_list.push(`<span class="report"><i class="far fa-utensils"></i> Reported: Intentional Feeding</span>`);
                if (commend_teach || commend_lead || commend_friend || commend_forgive) summary_list.push(`<span class="commend"><i class="far fa-thumbs-up"></i> Commended</span>`);
                if (!report_comm && !report_abi && !report_feed && !commend_teach && !commend_lead && !commend_friend && !commend_forgive) summary_list.push(`<span class="report"><i class="far fa-id-badge"></i> Reported: Did Not Played Selected Role</span>`);
                */
                
                let summary = summary_list.join("<br />");
                const col3 = (`<td class="summary">${match_id}</td>`);

                let class1 = "outcome_unknown";
                if (match_outcome == team) {
                    class1 = "outcome_win";
                } else if (match_outcome != team){
                    class1 = "outcome_lose";
                }

                class2 = "data_unknown";

                /*
                if (report_comm || report_abi || report_feed) {
                    class2 = "data_report";
                } else if (commend_teach || commend_lead || commend_friend || commend_forgive) {
                    class2 = "data_commend";
                } else {
                    class2 = "data_unknown"
                }
                */

                
                /*if (last_row_id === match_id) {*/
                if (false) {
                    last_row_summary.append("<hr />");
                    last_row_summary.append(summary);
                    last_row_elem.addClass(class1);
                    last_row_elem.addClass(class2);
                } else {
                    const $tr = $(`<tr class="match_row ${class1} ${class2}"></tr>`);
                    const $col1 = $(col1);
                    const $col2 = $(col2);
                    const $col3 = $(col3);
                    $tr.append($col1);
                    $tr.append($col2);
                    $tr.append($col3);
                    last_row_id = match_id;
                    last_row_elem = $tr;
                    last_row_summary = $col3;
                    $tbody.append($tr);
                }
                
            };

            const formatGameMode = (lobby, mode) => {
                const lobby_list = {
                    0: "Normal",
                    1: "Practice",
                    2: "Tournament",
                    3: "Tutorial",
                    4: "Co-op with bots",
                    5: "Team match",
                    6: "Solo Queue",
                    7: "Ranked",
                    8: "Solo Mid 1vs1",
                };
                const mode_list = {
                    23: "Turbo",
                    24: "Mutation",
                };
                return (lobby_list[lobby] || "Unknown") + " " + (mode_list[mode] || "");
            };

            const formatDuration = (seconds) => {
                let leftover = seconds;
                let output = "";
                if (leftover > 3600) {
                    output += Math.floor(leftover / 3600) + ":";
                    leftover = leftover % 3600;
                }
                let minute = Math.floor(leftover / 60);
                let second = leftover % 60;
                if (minute < 10) minute = `0${minute}`;
                if (second < 10) second = `0${second}`;
                output += `${minute}:${second}`;
                return output;
            };

            const process = (row, i) => {
                if (!row) {
                    if (i < data.length - 1) {
                        setTimeout(() => {
                            process(data[i + 1], i + 1);
                        }, 100); // throttle to 1 request/sec
                    } else {
                        $("#loading").hide();
                    }
                    return;
                }
                /*Parse a row of data into vars*/
                const parsed_row = row.split("|");
                const match_id = parsed_row[0];
                const accountId = parsed_row[1];
                const matchMode = parsed_row[2];
                const duration = parsed_row[3];
                const serverVersion = parsed_row[4];
                const matchOutcome = parsed_row[5];
                const totalTurns = parsed_row[6];
                const startTime = parsed_row[7];
                const clusterId = parsed_row[8];
                const team = parsed_row[9];
                const flags = parsed_row[10];
                const tower1 = parsed_row[11];
                const tower2 = parsed_row[12];
                const tower3 = parsed_row[13];
                const ancient = parsed_row[14];
                const gameClock = parsed_row[15];
                const hero1 = parsed_row[16];
                const hero2 = parsed_row[17];
                const hero3 = parsed_row[18];
                const hero4 = parsed_row[19];
                const hero5 = parsed_row[20];
                const gauntletType = parsed_row[21];
                const deckCode = parsed_row[22];

                if (isNaN(parseInt(match_id))) {
                    return;
                }

                $.get(`https://api.opendota.com/api/matches/${match_id}`).done((response) => {
                    const timestamp = response.start_time;
                    const date_obj = new Date(timestamp * 1000);
                    const date_string = date_obj.toLocaleString();

                    const gamemode = formatGameMode(response.lobby_type, response.game_mode);
                    const duration = formatDuration(response.duration);

                    let players = response.players.filter((p) => p.personaname === name);
                    let player = players.length === 1 ? players[0] : null;
                    while (!player) {
                        let acc_id = localStorage.getItem(`account_id`);
                        if (!acc_id) {
                            console.log(response.players);
                            const match_summary = response.players.map((p, i) => `${i + 1} = ${p.personaname || "Unknown"} (${heroes_map[p.hero_id].localized_name})`).join("\n");
                            let idx = prompt(`Who are you in this match?\n\n${match_summary}\n\ntype in 0 to cancel`);
                            try {
                                idx = parseInt(idx);
                            } catch (e) {
                                idx = 10000;
                            }
                            if (idx === 0) {
                                break;
                            }
                            player = response.players[idx - 1];
                            if (player) {
                                acc_id = player.account_id;
                                localStorage.setItem(`account_id`, acc_id);
                            }
                        } else {
                            players = response.players.filter((p) => `${p.account_id}` === acc_id);
                            player = players.length === 1 ? players[0] : null;
                            if (!player) {
                                localStorage.setItem(`account_id`, "");
                            }
                        }
                    }
                    if (!player) {
                        console.log(`Error retrieving player data of ${match_id}`);
                        // $tbody.append(`<tr><td colspan="3">Error retrieving player data of ${match_id}</td></tr>`);
                        create_row({
                            match_id,
                            date_string: date_string + "<br />Error Unable to identify your hero",
                            outcome: "",
                            gamemode,
                            duration,
                            score_k: "-",
                            score_d: "-",
                            score_a: "-",
                            hero_img: "http://via.placeholder.com/127x71?text=Error",
                            report_comm,
                            report_abi,
                            report_feed,
                            commend_lead,
                            commend_teach,
                            commend_friend,
                            commend_forgive,
                        });
                        return;
                    }
                    const hero_id = player.hero_id;
                    const hero = heroes_map[hero_id]; // heroes.heroes.filter((h) => h.id === hero_id)[0];
                    if (!hero) {
                        console.log(`Error retrieving hero data of ${match_id}: ${hero_id}`);
                        // $tbody.append(`<tr><td colspan="3">Error retrieving hero data of ${match_id}</td></tr>`);
                        create_row({
                            match_id,
                            date_string: date_string + "<br />Error Hero data not found",
                            outcome: "",
                            gamemode,
                            duration,
                            score_k: "-",
                            score_d: "-",
                            score_a: "-",
                            hero_img: "http://via.placeholder.com/127x71?text=Error",
                            report_comm,
                            report_abi,
                            report_feed,
                            commend_lead,
                            commend_teach,
                            commend_friend,
                            commend_forgive,
                        });
                        return;
                    }
                    const hero_name = hero.name;
                    const hero_fullname = hero.localized_name;
                    const hero_img = `http://cdn.dota2.com/apps/dota2/images/heroes/${hero_name}_hphover.png`;
                    const score_k = player.kills;
                    const score_d = player.deaths;
                    const score_a = player.assists;
                    const outcome = player.win;

                    const match_data = {
                        date_string,
                        outcome,
                        gamemode,
                        duration,
                        score_k,
                        score_d,
                        score_a,
                        hero_img,
                    };

                    localStorage.setItem(`matchdata-${match_id}`, JSON.stringify(match_data));
                    process_response(match_data);

                }).fail(() => {
                    create_row({
                        match_id,
                        matchMode,
                        duration,
                        serverVersion,
                        matchOutcome,
                        totalTurns,
                        startTime,
                        clusterId,
                        team,
                        flags,
                        tower1,
                        tower2,
                        tower3,
                        ancient,
                        gameClock,
                        hero1,
                        hero2,
                        hero3,
                        hero4,
                        hero5,
                        gauntletType,
                        deckCode,
                    });
                }).always(() => {
                    if (i < data.length - 1) {
                        setTimeout(() => {
                            process(data[i + 1], i + 1);
                        }, 5000); // throttle to 1 request/sec
                    } else {
                        $("#loading").hide();
                    }
                });
            };
            process(data[1], 1);
        }
    });
</script>

</html>
